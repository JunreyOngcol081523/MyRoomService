@page "{id:guid}"
@using MyRoomService.Domain.Entities
@model MyRoomService.Pages.Units.EditModel
@{
    ViewData["Title"] = "Edit Unit";
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">Edit Unit @Model.Unit.UnitNumber</h2>
            <p class="text-muted"><i class="bi bi-building me-1"></i> @Model.BuildingName</p>
        </div>
        <a asp-page="/Buildings/ManageBuilding" asp-route-id="@Model.Unit.BuildingId" class="btn btn-light rounded-pill border">Back to Building</a>
    </div>

    <form method="post" id="unitForm">
        <input type="hidden" asp-for="Unit.Id" />
        <input type="hidden" asp-for="Unit.BuildingId" />
        <input type="hidden" asp-for="Unit.TenantId" />

        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                        <h5 class="fw-bold"><i class="bi bi-info-circle me-2"></i>Unit Details</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <label asp-for="Unit.UnitNumber" class="form-label fw-semibold">Unit/Room Number</label>
                            <input asp-for="Unit.UnitNumber" class="form-control" required />
                            <span asp-validation-for="Unit.UnitNumber" class="text-danger small"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="Unit.FloorLevel" class="form-label fw-semibold">Floor Level</label>
                            <input asp-for="Unit.FloorLevel" class="form-control" type="number" />
                        </div>
                        <div class="mb-3">
                            <label asp-for="Unit.RentalMode" class="form-label fw-semibold">Rental Mode</label>
                            <select asp-for="Unit.RentalMode" class="form-select">
                                <option value="ENTIRE_UNIT">Entire Unit (Apartment/Commercial Space)</option>
                                <option value="PER_BED">Per Bed (Dormitory/BoardingHouse)</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Unit.MaxOccupancy" class="form-label fw-semibold">Max Occupancy</label>
                                <input asp-for="Unit.MaxOccupancy" class="form-control" type="number" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Unit.Status" class="form-label fw-semibold">Status</label>
                                <select asp-for="Unit.Status" class="form-select" asp-items="Html.GetEnumSelectList<UnitStatus>()"></select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label asp-for="Unit.DefaultRate" class="form-label fw-semibold">Default Monthly Rate</label>
                            <div class="input-group">
                                <span class="input-group-text">₱</span>
                                <input asp-for="Unit.DefaultRate" class="form-control" type="number" step="0.01" required />
                            </div>
                            <span asp-validation-for="Unit.DefaultRate" class="text-danger small"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-header bg-white border-bottom-0 pt-4 pb-0 d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0"><i class="bi bi-tags me-2"></i>Unit Services & Add-ons</h5>
                        <button type="button" class="btn btn-sm btn-outline-info rounded-pill px-3 shadow-sm" data-bs-toggle="modal" data-bs-target="#addServiceModal">
                            <i class="bi bi-plus-lg me-1"></i> Add Service
                        </button>
                    </div>
                    <div class="card-body p-4">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle border" id="servicesTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Service Name</th>
                                        <th class="text-end">Monthly Price</th>
                                        <th class="text-center" style="width: 80px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                            <div id="emptyServicesState" class="text-center py-4 text-muted small" style="display:none;">
                                No specific services added yet. Click "Add Service" to include default charges for this unit.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="hiddenInputsContainer"></div>

        <div class="mt-4 pt-3 border-top d-flex justify-content-end gap-2">
            <a asp-page="/Buildings/ManageBuilding" asp-route-id="@Model.Unit.BuildingId" class="btn btn-light px-4">Cancel</a>
            <button type="submit" class="btn btn-primary px-5 shadow-sm fw-bold">Save Changes</button>
        </div>
    </form>
</div>

@* --- ADD SERVICE MODAL --- *@
<div class="modal fade" id="addServiceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold text-dark">Add Unit Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-semibold text-muted small text-uppercase">Service Name</label>
                    <input type="text" id="modalCustomName" class="form-control border-secondary" placeholder="e.g. High-Speed Wi-Fi" />
                    <div class="form-text small">Enter the name of the service tied to this unit.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold text-primary small text-uppercase">Monthly Price (₱)</label>
                    <input type="number" id="modalPrice" class="form-control border-primary shadow-sm fw-bold" step="0.01" placeholder="0.00" />
                </div>
            </div>
            <div class="modal-footer border-top-0 pt-0">
                <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="btnAddServiceToList" class="btn btn-primary px-4 shadow-sm">Add to Unit</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let selectedServices = @Html.Raw(Model.ExistingServicesJson);

            const customNameInput = document.getElementById("modalCustomName");
            const priceInput = document.getElementById("modalPrice");

            function renderTable() {
                const tbody = document.querySelector("#servicesTable tbody");
                const hiddenContainer = document.getElementById("hiddenInputsContainer");
                const emptyState = document.getElementById("emptyServicesState");

                tbody.innerHTML = "";
                hiddenContainer.innerHTML = "";

                if (selectedServices.length === 0) {
                    emptyState.style.display = "block";
                    document.getElementById("servicesTable").style.display = "none";
                } else {
                    emptyState.style.display = "none";
                    document.getElementById("servicesTable").style.display = "table";

                    selectedServices.forEach((service, index) => {
                        // Render visible table row
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td class="fw-bold text-dark">${service.Name}</td>
                            <td class="text-end text-primary fw-bold">₱${parseFloat(service.MonthlyPrice).toFixed(2)}</td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-outline-danger border-0 rounded-circle" onclick="removeService(${index})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);

                        // Render hidden inputs for ASP.NET Core Model Binding
                        hiddenContainer.innerHTML += `
                            <input type="hidden" name="SelectedServices[${index}].Name" value="${service.Name}" />
                            <input type="hidden" name="SelectedServices[${index}].MonthlyPrice" value="${service.MonthlyPrice}" />
                        `;
                    });
                }
            }

            // Add Service Button Click
            document.getElementById("btnAddServiceToList").addEventListener("click", function () {
                const name = customNameInput.value.trim();
                const price = parseFloat(priceInput.value);

                if (!name || isNaN(price)) {
                    alert("Please provide a valid service name and monthly price.");
                    return;
                }

                selectedServices.push({ Name: name, MonthlyPrice: price });
                renderTable();

                // Clean up modal
                customNameInput.value = "";
                priceInput.value = "";

                const modalEl = document.getElementById('addServiceModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
            });

            // Make remove function globally accessible
            window.removeService = function(index) {
                selectedServices.splice(index, 1);
                renderTable();
            };

            // Initial render of existing services from the database
            renderTable();
        });
    </script>
}