@page "{id:guid}"
@using MyRoomService.Domain.Entities
@model MyRoomService.Pages.Units.EditModel
@{
    ViewData["Title"] = "Edit Unit";
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">Edit Unit @Model.Unit.UnitNumber</h2>
            <p class="text-muted"><i class="bi bi-building me-1"></i> @Model.BuildingName</p>
        </div>
        <a asp-page="/Buildings/ManageBuilding" asp-route-id="@Model.Unit.BuildingId" class="btn btn-light rounded-pill border">Back to Building</a>
    </div>

    @if (!ModelState.IsValid)
    {
        <div class="alert alert-danger shadow-sm rounded-4">
            <div asp-validation-summary="All" class="text-danger mb-0"></div>
        </div>
    }

    <form method="post" id="unitForm">
        <input type="hidden" asp-for="Unit.Id" />
        <input type="hidden" asp-for="Unit.BuildingId" />

        <div class="row g-4">
            @* --- Left Column: Unit Details --- *@
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                        <h5 class="fw-bold"><i class="bi bi-info-circle me-2"></i>Unit Details</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <label asp-for="Unit.UnitNumber" class="form-label fw-semibold">Unit/Room Number</label>
                            <input asp-for="Unit.UnitNumber" class="form-control" required />
                            <span asp-validation-for="Unit.UnitNumber" class="text-danger small"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="Unit.FloorLevel" class="form-label fw-semibold">Floor Level</label>
                            <input asp-for="Unit.FloorLevel" class="form-control" type="number" />
                        </div>
                        <div class="mb-3">
                            <label asp-for="Unit.RentalMode" class="form-label fw-semibold">Rental Mode</label>
                            <select asp-for="Unit.RentalMode" class="form-select">
                                <option value="ENTIRE_UNIT">Entire Unit (Apartment/Commercial Space)</option>
                                <option value="PER_BED">Per Bed (Dormitory/BoardingHouse)</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Unit.MaxOccupancy" class="form-label fw-semibold">Max Occupancy</label>
                                <input asp-for="Unit.MaxOccupancy" class="form-control" type="number" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Unit.Status" class="form-label fw-semibold">Status</label>
                                <select asp-for="Unit.Status" class="form-select" asp-items="Html.GetEnumSelectList<UnitStatus>()"></select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label asp-for="Unit.DefaultRate" class="form-label fw-semibold">Default Monthly Rate</label>
                            <div class="input-group">
                                <span class="input-group-text">₱</span>
                                <input asp-for="Unit.DefaultRate" class="form-control" type="number" step="0.01" required />
                            </div>
                            <span asp-validation-for="Unit.DefaultRate" class="text-danger small"></span>
                        </div>
                    </div>
                </div>
            </div>

            @* --- Right Column: Unit Services & Add-ons --- *@
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-header bg-white border-bottom-0 pt-4 pb-0 d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0"><i class="bi bi-tags me-2"></i>Unit Services & Add-ons</h5>
                        <button type="button" id="btnOpenAddModal" class="btn btn-sm btn-outline-info rounded-pill px-3 shadow-sm">
                            <i class="bi bi-plus-lg me-1"></i> Add Service
                        </button>
                    </div>
                    <div class="card-body p-4">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle border" id="servicesTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Service Name</th>
                                        <th class="text-end">Price/Rate</th>
                                        <th class="text-center" style="width: 100px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @* Dynamic Rows via JS *@
                                </tbody>
                            </table>
                            <div id="emptyServicesState" class="text-center py-4 text-muted small" style="display:none;">
                                No specific services added yet. Click "Add Service" to include default charges for this unit.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="hiddenInputsContainer"></div>

        <div class="mt-4 pt-3 border-top d-flex justify-content-end gap-2">
            <a asp-page="/Buildings/ManageBuilding" asp-route-id="@Model.Unit.BuildingId" class="btn btn-light px-4">Cancel</a>
            <button type="submit" class="btn btn-primary px-5 shadow-sm fw-bold">Save Changes</button>
        </div>
    </form>
</div>

@* --- SURGICAL ADD/EDIT SERVICE MODAL --- *@
<div class="modal fade" id="addServiceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold text-dark" id="modalTitle">Add Unit Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalEditIndex" value="-1" />

                @* 🚨 THE DATALIST AUTOSUGGEST *@
                <datalist id="serviceNameSuggestions">
                    @if (Model.CommonServiceNames != null)
                    {
                        foreach (var name in Model.CommonServiceNames)
                        {
                            <option value="@name" />
                        }
                    }
                </datalist>

                <div class="mb-3">
                    <label class="form-label fw-semibold text-muted small text-uppercase">Service Name</label>
                    <input type="text" id="modalCustomName" list="serviceNameSuggestions" class="form-control border-secondary" placeholder="e.g. Electricity, Water, Wi-Fi" autocomplete="off" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold text-muted small text-uppercase d-block">Billing Type</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="billingType" id="typeFixed" value="false" checked autocomplete="off">
                        <label class="btn btn-outline-primary" for="typeFixed"><i class="bi bi-calendar-check me-1"></i> Fixed</label>

                        <input type="radio" class="btn-check" name="billingType" id="typeMetered" value="true" autocomplete="off">
                        <label class="btn btn-outline-primary" for="typeMetered"><i class="bi bi-speedometer2 me-1"></i> Metered</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label id="priceLabel" class="form-label fw-semibold text-primary small text-uppercase">Monthly Price (₱)</label>
                    <input type="number" id="modalPrice" class="form-control border-primary shadow-sm fw-bold" step="0.01" placeholder="0.00" />
                    <div id="priceHelp" class="form-text small text-info">Flat amount charged every month.</div>
                </div>

                <div id="meterNumberSection" class="mb-3 d-none">
                    <label class="form-label fw-semibold text-muted small text-uppercase">Meter Serial Number</label>
                    <input type="text" id="modalMeterNumber" class="form-control border-secondary" placeholder="e.g. SN-12345" />
                </div>
            </div>
            <div class="modal-footer border-top-0 pt-0">
                <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="btnSaveServiceToList" class="btn btn-primary px-4 shadow-sm">Save Service</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // 🚨 FIX: Normalize the JSON immediately on load
            // This handles serialization casing (id vs Id) and sanitizes nulls
            let rawServices = @Html.Raw(Model.ExistingServicesJson);
            let selectedServices = rawServices.map(s => ({
                Id:           s.Id           ?? s.id           ?? '',
                Name:         s.Name         ?? s.name         ?? '',
                MonthlyPrice: s.MonthlyPrice ?? s.monthlyPrice ?? 0,
                IsMetered:    s.IsMetered    ?? s.isMetered    ?? false,
                MeterNumber:  s.MeterNumber  ?? s.meterNumber  ?? ''
            }));

            const serviceModal = new bootstrap.Modal(document.getElementById('addServiceModal'));
            const modalTitle = document.getElementById("modalTitle");
            const editIndexInput = document.getElementById("modalEditIndex");
            const customNameInput = document.getElementById("modalCustomName");
            const priceInput = document.getElementById("modalPrice");
            const meterNumberInput = document.getElementById("modalMeterNumber");
            const radioFixed = document.getElementById("typeFixed");
            const radioMetered = document.getElementById("typeMetered");
            const priceLabel = document.getElementById("priceLabel");
            const priceHelp = document.getElementById("priceHelp");
            const meterSection = document.getElementById("meterNumberSection");

            function toTitleCase(str) {
                return str.replace(
                    /\w\S*/g,
                    function(txt) {
                        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                    }
                );
            }

            function updateModalUI() {
                if (radioMetered.checked) {
                    priceLabel.innerText = "Rate per Unit (₱)";
                    priceHelp.innerText = "The cost per kWh, Cubic Meter, etc.";
                    meterSection.classList.remove('d-none');
                } else {
                    priceLabel.innerText = "Monthly Price (₱)";
                    priceHelp.innerText = "Flat amount charged every month.";
                    meterSection.classList.add('d-none');
                }
            }

            radioFixed.addEventListener('change', updateModalUI);
            radioMetered.addEventListener('change', updateModalUI);

            function renderTable() {
                const tbody = document.querySelector("#servicesTable tbody");
                const hiddenContainer = document.getElementById("hiddenInputsContainer");
                const emptyState = document.getElementById("emptyServicesState");

                tbody.innerHTML = "";
                hiddenContainer.innerHTML = "";

                if (selectedServices.length === 0) {
                    emptyState.style.display = "block";
                    document.getElementById("servicesTable").style.display = "none";
                } else {
                    emptyState.style.display = "none";
                    document.getElementById("servicesTable").style.display = "table";

                    selectedServices.forEach((service, index) => {
                        // Notice how clean this is now! No more `service.Id || service.id`
                        const isMetered = String(service.IsMetered).toLowerCase() === "true";

                        const typeBadge = isMetered
                            ? '<span class="badge bg-info-soft text-info small ms-2"><i class="bi bi-speedometer2"></i> Metered</span>'
                            : '';

                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>
                                <div class="fw-bold text-dark">${service.Name} ${typeBadge}</div>
                                ${isMetered ? `<div class="small text-muted">Meter: ${service.MeterNumber || 'N/A'}</div>` : ''}
                            </td>
                            <td class="text-end text-primary fw-bold">₱${parseFloat(service.MonthlyPrice).toFixed(2)}</td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-outline-primary border-0 rounded-circle me-1" onclick="openEditModal(${index})" title="Edit Service">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger border-0 rounded-circle" onclick="removeService(${index})" title="Remove Service">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);

                        hiddenContainer.innerHTML += `
                            <input type="hidden" name="SelectedServices[${index}].Id" value="${service.Id}" />
                            <input type="hidden" name="SelectedServices[${index}].Name" value="${service.Name}" />
                            <input type="hidden" name="SelectedServices[${index}].MonthlyPrice" value="${service.MonthlyPrice}" />
                            <input type="hidden" name="SelectedServices[${index}].MeterNumber" value="${service.MeterNumber}" />

                            <input type="checkbox" name="SelectedServices[${index}].IsMetered" value="true" ${isMetered ? 'checked' : ''} style="display:none;" />
                            <input type="hidden" name="SelectedServices[${index}].IsMetered" value="false" />
                        `;
                    });
                }
            }

            document.getElementById("btnOpenAddModal").addEventListener("click", function () {
                modalTitle.innerText = "Add Unit Service";
                editIndexInput.value = "-1";
                customNameInput.value = "";
                priceInput.value = "";
                meterNumberInput.value = "";
                radioFixed.checked = true;
                updateModalUI();
                serviceModal.show();
            });

            window.openEditModal = function(index) {
                const service = selectedServices[index];

                modalTitle.innerText = "Edit Unit Service";
                editIndexInput.value = index;

                // Clean references here too
                customNameInput.value = service.Name;
                priceInput.value = service.MonthlyPrice;
                meterNumberInput.value = service.MeterNumber;

                const isMetered = String(service.IsMetered).toLowerCase() === "true";
                if (isMetered) {
                    radioMetered.checked = true;
                } else {
                    radioFixed.checked = true;
                }

                updateModalUI();
                serviceModal.show();
            };

            document.getElementById("btnSaveServiceToList").addEventListener("click", function () {
                const name = toTitleCase(customNameInput.value.trim());
                const price = parseFloat(priceInput.value);
                const isMetered = radioMetered.checked;
                const meterNumber = meterNumberInput.value.trim();
                const editIndex = parseInt(editIndexInput.value);

                if (!name || isNaN(price)) {
                    alert("Please provide a valid service name and monthly price.");
                    return;
                }

                // 🚨 FIX: Strict ID handling
                const existingId = (editIndex >= 0) ? (selectedServices[editIndex].Id || '') : '';

                const serviceData = {
                    Id: existingId,
                    Name: name,
                    MonthlyPrice: price,
                    IsMetered: isMetered,
                    MeterNumber: meterNumber
                };

                if (editIndex >= 0) {
                    selectedServices[editIndex] = serviceData;
                } else {
                    selectedServices.push(serviceData);
                }

                renderTable();
                serviceModal.hide();
            });

            window.removeService = function(index) {
                selectedServices.splice(index, 1);
                renderTable();
            };

            renderTable();
        });
    </script>

    <style>
        .bg-info-soft {
            background-color: #e1f5fe;
            color: #0288d1;
            border: 1px solid #b3e5fc;
            padding: 0.35em 0.65em;
        }
    </style>
}