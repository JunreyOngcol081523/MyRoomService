<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - RentFlow</title>
    <script type="importmap"></script>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/RentFlow.styles.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
    @if (User.Identity?.IsAuthenticated == true)
    {
        <div class="d-flex vh-100 overflow-hidden">

            @* --- SIDEBAR (Responsive Offcanvas) --- *@
            @* UPDATED: Replaced bg-dark with explicit inline style to guarantee the moss-dark theme applies correctly *@
            <aside class="offcanvas-md offcanvas-start bg-dark text-white d-flex flex-column flex-shrink-0 p-3 shadow" tabindex="-1" id="appSidebar" style="width: 260px;">
                @* Branding & Mobile Close Button *@
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <a asp-area="" asp-page="/Index" class="d-flex align-items-center text-white text-decoration-none">
                        <i class="bi bi-buildings fs-3 me-2 text-primary"></i>
                        <span class="fs-4 fw-bold">RentFlow</span>
                    </a>
                    @* This close button only shows on mobile (d-md-none) *@
                    <button type="button" class="btn-close btn-close-white d-md-none" data-bs-dismiss="offcanvas" data-bs-target="#appSidebar" aria-label="Close"></button>
                </div>

                <hr class="text-white-50 mt-0">

                @* Navigation Links *@
                <ul class="nav nav-pills flex-column mb-auto overflow-auto" id="sidebarMenu">
                    <li class="nav-item mb-1">
                        <a asp-page="/Index" class="nav-link text-white" aria-current="page">
                            <i class="bi bi-grid me-2"></i> Dashboard
                        </a>
                    </li>

                    <li class="nav-item mb-1">
                        <a href="#buildingsSubmenu" data-bs-toggle="collapse" class="nav-link text-white d-flex justify-content-between align-items-center" aria-expanded="false">
                            <div>
                                <i class="bi bi-building me-2"></i> Buildings
                            </div>
                            <i class="bi bi-chevron-down ms-auto" style="font-size: 0.8rem;"></i>
                        </a>
                        <ul class="collapse nav flex-column ms-3 mt-1" id="buildingsSubmenu" data-bs-parent="#sidebarMenu">
                            <li class="nav-item">
                                <a asp-page="/Buildings/Create" asp-route-status="Active" class="nav-link text-white-50 py-1 mb-1">
                                    <i class="bi bi-building-add me-2"></i> Register New Building
                                </a>
                            </li>
                            <li class="nav-item">
                                <a asp-page="/Buildings/Index" asp-route-status="Active" class="nav-link text-white-50 py-1 mb-1">
                                    <i class="bi bi-building-check me-2"></i> Active Buildings
                                </a>
                            </li>
                            <li class="nav-item">
                                <a asp-page="/Buildings/Index" asp-route-status="Archived" class="nav-link text-white-50 py-1 mb-1">
                                    <i class="bi bi-archive me-2"></i> Archived Buildings
                                </a>
                            </li>
                        </ul>
                    </li>

                    @* ADDED: Occupants Collapsible Submenu *@
                    <li class="nav-item mb-1">
                        <a href="#occupantsSubmenu" data-bs-toggle="collapse" class="nav-link text-white d-flex justify-content-between align-items-center" aria-expanded="false">
                            <div>
                                <i class="bi bi-people me-2"></i> Occupants
                            </div>
                            <i class="bi bi-chevron-down ms-auto" style="font-size: 0.8rem;"></i>
                        </a>
                        <ul class="collapse nav flex-column ms-3 mt-1" id="occupantsSubmenu" data-bs-parent="#sidebarMenu">
                            <li class="nav-item">
                                <a asp-page="/Occupants/Create" class="nav-link text-white-50 py-1 mb-1">
                                    <i class="bi bi-person-add me-2"></i> Register New Occupant
                                </a>
                            </li>
                            <li class="nav-item">
                                <a asp-page="/Occupants/Index" class="nav-link text-white-50 py-1 mb-1">
                                    <i class="bi bi-person-check me-2"></i> Active Occupants
                                </a>
                            </li>
                            <li class="nav-item">
                                <a asp-page="/Occupants/ArchivedOccupants" class="nav-link text-white-50 py-1 mb-1">
                                    <i class="bi bi-person-dash me-2"></i> Archived Occupants
                                </a>
                            </li>
                        </ul>
                    </li>

                    @* ADDED: Contracts Menu Item *@
                    <li class="nav-item mb-1">
                        <a asp-page="/Contracts/Index" class="nav-link text-white">
                            <i class="bi bi-file-earmark-text me-2"></i> Contracts
                        </a>
                    </li>

                    <li class="nav-item mb-1">
                        <a href="#billingSubmenu" data-bs-toggle="collapse" class="nav-link text-white d-flex justify-content-between align-items-center" aria-expanded="false">
                            <div>
                                <i class="bi bi-receipt me-2"></i> Bills & Payments
                            </div>
                            <i class="bi bi-chevron-down ms-auto" style="font-size: 0.8rem;"></i>
                        </a>
                        <ul class="collapse nav flex-column ms-3 mt-1" id="billingSubmenu" data-bs-parent="#sidebarMenu">
                            <li class="nav-item">
                                <a asp-page="/Invoices/Index" class="nav-link text-white-50 py-1 mb-1">
                                    <i class="bi bi-file-earmark-text me-2"></i> Active Invoices
                                </a>
                            </li>
                            <li class="nav-item">
                                <a asp-page="/Invoices/Completed" class="nav-link text-white-50 py-1 mb-1">
                                    <i class="bi bi-check2-square me-2"></i> Completed Transactions
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="nav-item mb-1">
                        <a asp-page="/MeterReadings/Index" class="nav-link text-white">
                            <i class="bi bi-speedometer2 me-2"></i> Meter Readings
                        </a>
                    </li>
                    <li class="nav-item mb-1">
                        <a asp-page="/Settings/Index" class="nav-link text-white">
                            <i class="bi bi-gear me-2"></i> Settings
                        </a>
                    </li>
                    <li class="nav-item mb-1">
                        <a asp-page="/Contact" class="nav-link text-white">
                            <i class="bi bi-envelope me-2"></i> Contact Us
                        </a>
                    </li>
                    <li class="nav-item mb-1">
                        <a asp-page="/About" class="nav-link text-white">
                            <i class="bi bi-info-circle me-2"></i> About
                        </a>
                    </li>
                </ul>

                <hr class="text-white-50">

                @* Logout Area *@
                <div class="mt-2">
                    <form asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Page("/Index", new { area = "" })" method="post" class="w-100">
                        <button type="submit" class="nav-link text-white bg-transparent border-0 w-100 text-start d-flex align-items-center rounded hover-bg-danger">
                            <i class="bi bi-box-arrow-right fs-5 me-2 text-danger"></i>
                            <span>Logout</span>
                        </button>
                    </form>
                </div>
            </aside>

            @* --- MAIN CONTENT AREA --- *@
            @* UPDATED: Removed bg-light so the global CSS background color applies *@
            <div class="d-flex flex-column flex-grow-1 overflow-auto">

                <header class="bg-white border-bottom py-3 px-4 shadow-sm sticky-top">
                    <div class="d-flex justify-content-between align-items-center">

                        @* Mobile Menu Toggle & Title *@
                        <div class="d-flex align-items-center">
                            @* Hamburger Button (Only shows on mobile: d-md-none) *@
                            <button class="btn btn-light border d-md-none me-3 shadow-sm" type="button" data-bs-toggle="offcanvas" data-bs-target="#appSidebar" aria-controls="appSidebar">
                                <i class="bi bi-list fs-5"></i>
                            </button>
                            <h5 class="mb-0 fw-semibold text-dark">@ViewData["Title"]</h5>
                        </div>

                        <div>
                            <partial name="_LoginPartial" />
                        </div>
                    </div>
                </header>

                <main role="main" class="flex-grow-1 p-4">
                    <nav aria-label="breadcrumb" class="mb-4">
                        <ol class="breadcrumb bg-transparent p-0 mb-0">
                            <li class="breadcrumb-item">
                                <a asp-page="/Index" class="text-decoration-none">Dashboard</a>
                            </li>

                            @if (ViewData["Breadcrumbs"] is List<(string Title, string Url)> breadcrumbs)
                            {
                                foreach (var crumb in breadcrumbs)
                                {
                                    if (crumb == breadcrumbs.Last())
                                    {
                                        <li class="breadcrumb-item active" aria-current="page">@crumb.Title</li>
                                    }
                                    else
                                    {
                                        <li class="breadcrumb-item">
                                            <a href="@crumb.Url" class="text-decoration-none">@crumb.Title</a>
                                        </li>
                                    }
                                }
                            }
                        </ol>
                    </nav>

                    <div class="bg-white p-4 rounded shadow-sm border">
                        @RenderBody()
                    </div>
                </main>

                <footer class="bg-white border-top py-3 text-muted text-center mt-auto">
                    <div class="container-fluid small">
                        &copy; @DateTime.Now.Year - RentFlow - <a asp-area="" asp-page="/Privacy">Privacy Policy</a>
                    </div>
                </footer>
            </div>
        </div>
    }
    else
    {
        @* Unauthenticated View *@
        @* UPDATED: Removed bg-light here too *@
        <div class="d-flex flex-column min-vh-100">
            <header class="bg-white border-bottom py-3 shadow-sm">
                <div class="container d-flex justify-content-between align-items-center">
                    <a asp-area="" asp-page="/Index" class="text-decoration-none d-flex align-items-center">
                        <i class="bi bi-buildings fs-3 me-2 text-primary"></i>
                        <span class="fs-4 fw-bold text-dark">RentFlow</span>
                    </a>
                    <div>
                        <a asp-area="Identity" asp-page="/Account/Login" class="btn btn-outline-primary me-2">Login</a>
                        <a asp-area="Identity" asp-page="/Account/Register" class="btn btn-primary">Sign Up</a>
                    </div>
                </div>
            </header>

            <main role="main" class="flex-grow-1 d-flex align-items-center justify-content-center py-5">
                <div class="container">
                    @RenderBody()
                </div>
            </main>

            <footer class="bg-white border-top py-4 text-muted text-center mt-auto">
                <div class="container small">
                    &copy; @DateTime.Now.Year - RentFlow. <a asp-area="" asp-page="/Privacy" class="text-decoration-none">Privacy Policy</a> |
                    <a asp-area="" asp-page="/Contact" class="text-decoration-none">Contact Us</a>
                </div>
            </footer>
        </div>
    }

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>