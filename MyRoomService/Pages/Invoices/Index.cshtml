@page
@model MyRoomService.Pages.Invoices.IndexModel
@{
    ViewData["Title"] = "Invoices";
}

<style>
    .bg-success-soft {
        background-color: #e8f5e9 !important;
        color: #2e7d32 !important;
    }

    .bg-secondary-soft {
        background-color: #f5f5f5 !important;
        color: #616161 !important;
    }

    .badge {
        font-weight: 600;
    }
</style>

<div class="container-fluid py-4 px-lg-5">

    @if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        <div class="alert alert-info alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i> @Model.StatusMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0 text-dark">Invoice Management</h2>
            <p class="text-muted mb-0">Manage billing, track payments, and review drafts.</p>
        </div>

        <div class="d-flex gap-2">
            @* --- PUBLISH ALL BUTTON --- *@
            <form method="post" asp-page-handler="PublishAll">
                <button type="submit" class="btn btn-outline-success rounded-pill px-4 shadow-sm fw-bold"
                        onclick="return confirm('Are you sure you want to publish all unpaid drafts? Tenants will see them immediately.');">
                    <i class="bi bi-send-check-fill me-2"></i> Publish All Drafts
                </button>
            </form>

            @* --- UPDATED: DIRECT BILLING BUTTON (No Modal) --- *@
            @if (Model.IsBillingBlocked)
            {
                <button type="button" class="btn btn-warning rounded-pill px-4 shadow-sm fw-bold border-0"
                        title="Billing is blocked until all meter readings are entered.">
                    <i class="bi bi-lock-fill me-2"></i> Billing Locked
                </button>
            }
            else
            {
                <form method="post" asp-page-handler="Generate">
                    <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold"
                            onclick="return confirm('Are you sure you want to run the monthly billing cycle? All invoices will be generated as drafts for your review.');">
                        <i class="bi bi-lightning-charge-fill me-2"></i> Run Billing Cycle
                    </button>
                </form>
            }
        </div>
    </div>

    @* --- NEW: BLOCKER WARNING ALERT --- *@
    @if (Model.IsBillingBlocked)
    {
        <div class="alert alert-warning border-0 shadow-sm rounded-4 p-4 mb-4 d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
            <div class="d-flex align-items-center">
                <div class="bg-white bg-opacity-50 p-3 rounded-circle me-3 d-none d-sm-block">
                    <i class="bi bi-speedometer2 fs-3 text-warning"></i>
                </div>
                <div>
                    <h5 class="fw-bold mb-1">Incomplete Meter Readings</h5>
                    <p class="mb-2 small text-dark">The following units require meter readings before you can generate this month's invoices:</p>
                    <div class="d-flex flex-wrap gap-1">
                        @foreach (var unit in Model.PendingMeterUnits)
                        {
                            <span class="badge bg-dark bg-opacity-10 text-dark">@unit</span>
                        }
                    </div>
                </div>
            </div>
            <a asp-page="/MeterReadings/Index" class="btn btn-dark rounded-pill px-4 fw-bold shadow-sm text-nowrap">
                Enter Readings <i class="bi bi-arrow-right ms-2"></i>
            </a>
        </div>
    }

    @* --- FILTER CARD --- *@
    <div class="card border-0 shadow-sm rounded-4 mb-4">
        <div class="card-body p-4">
            <form method="get" class="row g-3">
                <input type="hidden" asp-for="PageSize" />
                <div class="col-md-3">
                    <label class="form-label text-muted small fw-bold">Search Occupant</label>
                    <input type="text" class="form-control" asp-for="SearchName" placeholder="Name..." />
                </div>
                <div class="col-md-2">
                    <label class="form-label text-muted small fw-bold">Status</label>
                    <select class="form-select" asp-for="StatusFilter">
                        <option value="">All Active</option>
                        <option value="UNPAID">Unpaid</option>
                        <option value="PARTIAL">Partial</option>
                        <option value="OVERDUE">Overdue</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label text-muted small fw-bold">Building</label>
                    <select class="form-select" asp-for="BuildingId" asp-items="Model.BuildingOptions" onchange="this.form.submit()">
                        <option value="">All Buildings</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label text-muted small fw-bold">Unit</label>
                    <select class="form-select" asp-for="UnitId" asp-items="Model.UnitOptions">
                        <option value="">All Units</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label text-muted small fw-bold">Date Range</label>
                    <div class="input-group">
                        <input type="date" class="form-control" asp-for="StartDate" />
                        <span class="input-group-text">to</span>
                        <input type="date" class="form-control" asp-for="EndDate" />
                    </div>
                </div>
                <div class="col-12 d-flex justify-content-end mt-3">
                    <a asp-page="./Index" class="btn btn-light rounded-pill px-4 me-2 border">Clear Filters</a>
                    <button type="submit" class="btn btn-secondary rounded-pill px-4 shadow-sm">
                        <i class="bi bi-funnel-fill me-1"></i> Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>

    @* --- TABLE CARD --- *@
    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body p-4">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light text-muted small text-uppercase">
                        <tr>
                            <th>Invoice ID</th>
                            <th>Occupant</th>
                            <th>Unit</th>
                            <th>Date</th>
                            <th class="text-end">Total Amount</th>
                            <th class="text-center">Visibility</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Invoices.Any())
                        {
                            foreach (var invoice in Model.Invoices)
                            {
                                <tr id="row-@invoice.Id">
                                    <td>
                                        <a asp-page="./Details" asp-route-id="@invoice.Id" class="fw-bold text-decoration-none">
                                            @invoice.Id.ToString().Substring(0, 8).ToUpper()
                                        </a>
                                    </td>
                                    <td class="fw-bold">@invoice.Occupant?.FullName</td>
                                    <td>@invoice.Contract?.Unit?.UnitNumber</td>
                                    <td>@invoice.InvoiceDate.ToString("MMM dd, yyyy")</td>
                                    <td class="text-end fw-bold text-primary">₱@invoice.TotalAmount.ToString("N2")</td>
                                    <td class="text-center">
                                        @if (invoice.IsPublished)
                                        {
                                            <span class="badge bg-success-soft text-success rounded-pill px-2">
                                                <i class="bi bi-eye me-1"></i> Live
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary-soft text-secondary rounded-pill px-2">
                                                <i class="bi bi-pencil me-1"></i> Draft
                                            </span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <span class="badge @(invoice.Status == "PAID" ? "bg-success" : (invoice.Status == "OVERDUE" ? "bg-danger" : (invoice.Status == "DRAFT" ? "bg-secondary" : "bg-warning text-dark"))) rounded-pill">
                                            @invoice.Status
                                        </span>
                                    </td>

                                    @* 🚨 NEW: Actions Column *@
                                    <td class="text-center">
                                        <a asp-page="./Details" asp-route-id="@invoice.Id" class="btn btn-sm btn-outline-primary shadow-sm" title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </a>

                                        @if (invoice.Status == "DRAFT" || !invoice.IsPublished)
                                        {
                                            <button type="button" class="btn btn-sm btn-outline-danger shadow-sm ms-1"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#deleteInvoiceModal"
                                                    onclick="prepareDelete('@invoice.Id', '@(invoice.Occupant?.FullName)', '@invoice.InvoiceDate.ToString("MMMM yyyy")')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1 border-0"
                                                    disabled
                                                    title="Only Drafts can be deleted. Published invoices must be Voided.">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            @* Pagination Controls *@
            @if (Model.TotalPages > 1)
            {
                <div class="d-flex justify-content-center mt-4">
                    <nav aria-label="Page navigation">
                        <ul class="pagination mb-0">
                            @for (int i = 1; i <= Model.TotalPages; i++)
                            {
                                <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                                    <a class="page-link" asp-route-PageIndex="@i"
                                       asp-route-SearchName="@Model.SearchName"
                                       asp-route-StatusFilter="@Model.StatusFilter"
                                       asp-route-BuildingId="@Model.BuildingId"
                                       asp-route-UnitId="@Model.UnitId"
                                       asp-route-StartDate="@Model.StartDate?.ToString("yyyy-MM-dd")"
                                       asp-route-EndDate="@Model.EndDate?.ToString("yyyy-MM-dd")">@i</a>
                                </li>
                            }
                        </ul>
                    </nav>
                </div>
            }
        </div>
    </div>
</div>
@* --- DELETE INVOICE MODAL --- *@
<div class="modal fade" id="deleteInvoiceModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white border-bottom-0 pb-3">
                <h5 class="modal-title fw-bold" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Delete Draft Invoice
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <p class="mb-1 text-dark">Are you sure you want to delete the draft invoice for:</p>
                <p class="fw-bold text-primary fs-5 mb-3" id="deleteModalOccupantName"></p>
                <p class="text-muted small mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    Deleting this draft will release any linked meter readings so they can be billed again. This action cannot be undone.
                </p>
            </div>
            <div class="modal-footer bg-light border-top-0 pt-3">
                <form method="post" asp-page-handler="DeleteDraft">
                    <input type="hidden" name="invoiceId" id="deleteModalInvoiceId" />
                    <button type="button" class="btn btn-light px-4 border" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger px-4 shadow-sm fw-bold">Yes, Delete Draft</button>
                </form>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        // 1. Prepare the Modal data (Same as before)
        function prepareDelete(invoiceId, occupantName, month) {
            document.getElementById('deleteModalInvoiceId').value = invoiceId;
            document.getElementById('deleteModalOccupantName').textContent = occupantName + ' (' + month + ')';
        }

        // 2. The AJAX / Fetch API Magic
        document.addEventListener('DOMContentLoaded', function () {
            const deleteForm = document.querySelector('#deleteInvoiceModal form');

            deleteForm.addEventListener('submit', async function (e) {
                e.preventDefault(); // 🚨 STOP the full page reload!

                // Get the data
                const invoiceId = document.getElementById('deleteModalInvoiceId').value;
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value; // Security token
                const submitBtn = deleteForm.querySelector('button[type="submit"]');

                // Visual feedback (Change button to "Deleting...")
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
                submitBtn.disabled = true;

                try {
                    // Send background request to the C# handler
                    const response = await fetch(`?handler=DeleteDraft`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': token // Required by Razor Pages
                        },
                        body: new URLSearchParams({ invoiceId: invoiceId })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // 1. Hide the Bootstrap Modal
                        const modalElement = document.getElementById('deleteInvoiceModal');
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        modalInstance.hide();

                        // 2. Find the table row and fade it out smoothly
                        const rowToDelete = document.getElementById(`row-${invoiceId}`);
                        if (rowToDelete) {
                            rowToDelete.style.transition = "opacity 0.4s ease, transform 0.4s ease";
                            rowToDelete.style.opacity = "0";
                            rowToDelete.style.transform = "translateX(-20px)";

                            // Wait for animation to finish, then remove from DOM
                            setTimeout(() => rowToDelete.remove(), 400);
                        }
                    } else {
                        alert("Error: " + result.message);
                    }
                } catch (error) {
                    console.error("AJAX Error:", error);
                    alert("A network error occurred.");
                } finally {
                    // Reset the button
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });
        });
    </script>
}